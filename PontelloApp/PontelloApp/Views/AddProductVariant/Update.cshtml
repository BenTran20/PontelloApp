@model PontelloApp.Models.ProductVariant

@{
    ViewData["Title"] = "Update Product Variant";
}
<div class="mb-1">
    <a asp-action="Index" asp-route-id="@Model.ProductId" class="btn btn-outline-secondary btn-sm">
        <em class="bi bi-arrow-left"></em> Back to Products
    </a>
</div>

<h1>Update Variant for @Model.Product?.ProductName</h1>

<form asp-action="Update" method="post">
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="ProductId" />
    <input type="hidden" asp-for="RowVersion" />

    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
            <!-- SKU -->
            <div class="mb-3">
                <label asp-for="SKU_ExternalID" class="form-label">
                    SKU
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="External product code for each variant."></i>
                </label>
                <input asp-for="SKU_ExternalID" class="form-control" placeholder="Enter SKU" />
                <span asp-validation-for="SKU_ExternalID" class="text-danger"></span>
            </div>

            <!-- Unit Price -->
            <div class="mb-3">
                <label asp-for="UnitPrice" class="form-label">
                    Unit Price
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Price for each variant, max 2 decimal places."></i>
                </label>
                <input asp-for="UnitPrice" type="text" class="form-control" placeholder="0.00" inputmode="decimal"
                       oninput="this.value = this.value.match(/^\d*(\.?\d{0,2})/)[0];" />
                <span asp-validation-for="UnitPrice" class="text-danger"></span>
            </div>

            <!-- Compare At Price -->
            <div class="mb-3">
                <label asp-for="CompareAtPrice" class="form-label">
                    Compare At Price
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Optional: Original price for comparison, max 2 decimal places."></i>
                </label>
                <input asp-for="CompareAtPrice" type="text" class="form-control" placeholder="0.00" inputmode="decimal"
                       oninput="this.value = this.value.match(/^\d*(\.?\d{0,2})/)[0];" />
                <span asp-validation-for="CompareAtPrice" class="text-danger"></span>
            </div>

            <!-- Stock Quantity -->
            <div class="mb-3">
                <label asp-for="StockQuantity" class="form-label">
                    Stock Quantity
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Number of items currently in stock."></i>
                </label>
                <input asp-for="StockQuantity" type="number" class="form-control" placeholder="0" />
                <span asp-validation-for="StockQuantity" class="text-danger"></span>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
            <!-- Weight -->
            <div class="mb-3">
                <label asp-for="Weight" class="form-label">
                    Weight
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Optional: Weight in kg."></i>
                </label>
                <input asp-for="Weight" type="text" class="form-control" placeholder="0.0000000" inputmode="decimal"
                       oninput="this.value = this.value.match(/^\d*(\.?\d{0,7})/)[0];" />
                <span asp-validation-for="Weight" class="text-danger"></span>
            </div>

            <!-- Barcode -->
            <div class="mb-3">
                <label asp-for="Barcode" class="form-label">
                    Barcode
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Optional: Barcode for scanning."></i>
                </label>
                <input asp-for="Barcode" class="form-control" placeholder="Enter barcode" />
                <span asp-validation-for="Barcode" class="text-danger"></span>
            </div>

            <!-- Inventory Policy -->
            <div class="mb-3">
                <label asp-for="InventoryPolicy" class="form-label">
                    Inventory Policy
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Inventory Policy Selection (Continue or Deny)."></i>
                </label>
                <select asp-for="InventoryPolicy" class="form-select"
                        asp-items="Html.GetEnumSelectList<InventoryPolicy>()">
                    <option value="">-- Select Policy --</option>
                </select>
                <span asp-validation-for="InventoryPolicy" class="text-danger"></span>
            </div>

            <!-- Status -->
            <div class="form-check mb-3">
                <input asp-for="Status" class="form-check-input" />
                <label asp-for="Status" class="form-check-label">
                    Active
                    <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Active = available; Inactive = hidden."></i>
                </label>
            </div>
        </div>
    </div>

    <hr />
    <!-- Options -->
    <h2>Options</h2>
    <small class="text-muted d-block mb-2">
        Add variant options, e.g., Size: M; Color: Red. Click "Add Option" to add more rows.
    </small>

    <div class="text-danger mb-2">
        @if (ViewData.ModelState.ContainsKey("Options") &&
                ViewData.ModelState["Options"].Errors.Count > 0)
        {
            foreach (var err in ViewData.ModelState["Options"].Errors)
            {
                <div>@err.ErrorMessage</div>
            }
        }
    </div>

    <table class="table table-sm" id="optionsTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Value</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Options.Count; i++)
            {
                <tr>
                    <td>
                        <input type="hidden" name="Options[@i].Id" value="@Model.Options[i].Id" />
                        <input name="Options[@i].Name" value="@Model.Options[i].Name" class="form-control" placeholder="e.g., Size" />
                        <span asp-validation-for="Options[@i].Name" class="text-danger"></span>
                    </td>
                    <td>
                        <input name="Options[@i].Value" value="@Model.Options[i].Value" class="form-control" placeholder="e.g., M" />
                        <span asp-validation-for="Options[@i].Value" class="text-danger"></span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm removeOptionBtn" title="Remove Option">Remove</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <button type="button" class="btn btn-secondary mb-3" id="addOptionBtn" title="Add Option">Add Option</button>

    <!--Code is included-->
    <div class="mt-4 d-flex justify-content-end">
        <a asp-action="Index"
           asp-route-id="@Model.ProductId"
           class="btn btn-outline-secondary me-2">
            Cancel
        </a>

        <button type="submit" class="btn btn-primary">
            Save Variant
        </button>
    </div>
</form>

@section Scripts {
    <script>
        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Dynamic Options Table
        let optionIndex = @Model.Options.Count;
        const tbody = document.querySelector('#optionsTable tbody');

        document.getElementById('addOptionBtn').addEventListener('click', function () {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="hidden" name="Options[${optionIndex}].Id" value="0" />
                    <input name="Options[${optionIndex}].Name" class="form-control" placeholder="e.g., Size" />
                </td>
                <td>
                    <input name="Options[${optionIndex}].Value" class="form-control" placeholder="e.g., M" />
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm removeOptionBtn">Remove</button>
                </td>
            `;
            tbody.appendChild(row);
            row.querySelector('.removeOptionBtn').addEventListener('click', () => row.remove());
            optionIndex++;
        });

        tbody.querySelectorAll('.removeOptionBtn').forEach(btn => {
            btn.addEventListener('click', () => btn.closest('tr').remove());
        });

        document.querySelector('form').addEventListener('submit', function() {
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, idx) => {
                row.querySelectorAll('input').forEach(input => {
                    if (input.name.includes('.Id')) input.name = `Options[${idx}].Id`;
                    if (input.name.includes('.Name')) input.name = `Options[${idx}].Name`;
                    if (input.name.includes('.Value')) input.name = `Options[${idx}].Value`;
                });
            });
        });
    </script>
}
